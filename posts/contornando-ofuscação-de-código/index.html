<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Contornando a ofuscação de código no Android | Jojo's Exception</title><meta name=keywords content="android-re,research"><meta name=description content="Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.
 Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.
 Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World!"><meta name=author content="Jojo"><link rel=canonical href=https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/><link href=https://exception.blog/assets/css/stylesheet.min.19d8234f7520f2216aca845b9f292982671403accc7e754ceb099b228a5980fe.css integrity="sha256-GdgjT3Ug8iFqyoRbnykpgmcUA6zMfnVM6wmbIopZgP4=" rel="preload stylesheet" as=style><link rel=icon href=https://exception.blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://exception.blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://exception.blog/favicon-32x32.png><link rel=apple-touch-icon href=https://exception.blog/apple-touch-icon.png><link rel=mask-icon href=https://exception.blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.79.0"><meta property="og:title" content="Contornando a ofuscação de código no Android"><meta property="og:description" content="Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.
 Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.
 Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World!"><meta property="og:type" content="article"><meta property="og:url" content="https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/"><meta property="article:published_time" content="2021-03-05T23:32:22-03:00"><meta property="article:modified_time" content="2021-03-05T23:32:22-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Contornando a ofuscação de código no Android"><meta name=twitter:description content="Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.
 Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.
 Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Contornando a ofuscação de código no Android","name":"Contornando a ofuscação de código no Android","description":"Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por …","keywords":["android-re","research"],"articleBody":"Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.\n Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.\n Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World! de acordo com a sua senioridade. No geral, considero que, se caso você estiver em uma enrascada para analisar uma aplicação, e não souber desenvolver em nada naquela plataforma, ou se quer entende de fato o que acontece por de trás das cortinas, com certeza está passando o carro na frente dos bois.\nEntender ao menos o básico do que está fazendo, é crucial para conseguir chegar do outro lado. Aposto com você, que o Orange-Tsai não indexou tantas vulnerabilidades críticas em aplicações baseadas na JVM (e também em PHP, e algumas outras dezenas de stacks de desenvolvimento) sem conhecer exatamente o que acontece até mesmo além da linguagem. Dito isso, talvez iniciar uma trilha de estudos focada nos conceitos básicos de desenvolvimento Android (para iOS, acredito que devo escrever algo focado especificamente para essa plataforma, e trazer um desenvolvedor nativo com mais experiência, não me sinto confortável para falar de Apple, visto que não atuo com seus produtos no dia-a-dia), e também de segurança ofensiva para ela.\n Na parte de dev, recomendo assinar a Alura, e estudar um pouco de nativo, e também de aplicações híbridas. Claro que o ideal, é focar seus estudos na stack que mais atua. No meu caso, fico no Flutter, Xamarin e no NDK, que também já entraria em uma postagem exclusiva para ele (mas dando um spoiler, você não precisa do Android Studio para desenvolver para Android). Já na parte de segurança ofensiva, o melhor conteúdo em nosso idioma, é feito pelo grande Maycon Vitali, com a Hack N' Roll Academy.\n A Sua Assinatura Começando com uma boa indicação de trilha sonora para o texto que vem a seguir, também vamos rever alguns entendimentos sobre o que é ofuscação de código, e o motivo da segurança por obscuridade - se é que a ofuscação de código pode ser considerada isso, eu sinceramente não sei responder, mas acredito que não. Mas acabo por ficar meio na dúvida, pois a vantagem, assim como na maioria das vezes, fica do lado do atacante -, ser tão amplamente implementada em aplicações Android. Em especial, aquelas de cunho financeiro, como fintechs e bancos no Brasil, na verdade já notei que diversas vezes os times de Application Security levam esse assunto e certificate pinning como bala de prata para aumentar a maturidade de segurança de uma aplicação, tentando deixar mais difícil a vida de quem vai audita-lá no futuro.\n A final de contas, para que utilizar a Safetynet, se você pode reter informações críticas de negócio no frontend ou até mesmo deixar algum segredo por lá, temos a ofuscação de código à caminho! (Acredito que a Guardsquare deve abrir um sorriso no rosto com essa mentalidade).\n E sobre o tema anterior, voltamos a focar no item o que é ofuscação de código. Afinal de contas, para a maioria das consultorias de segurança, análise de segurança ofensiva em aplicações Android, se limita em realizar o bypass de alguma coisa, e focar nas interações com a internet (AKA olhar somente para RESTful ou algum outro SDK que faça chamadas para a internet) ao invés da aplicação.\nShort long answer, com as soluções já consagradas de mercado, como o {Pro, Dex}Guard, seus contextos de aplicação vão bem além de somente ofuscar um código. Até na variante open-source, o ProGuard, ele efetua a otimização do bytecode, remove trechos de códigos que não podem ser acessíveis devido a algum fluxo lógico na aplicação, e de fato, efetua a ofuscação baseado em um dicionário.\nNa versão enterprise, o DexGuard, o negócio fica mais tenso. A proteção vai bem além de somente um bytecode direcionado para a JVM, e sai desse contexto que estamos comentando de análise estática, e vai até nas etapas de instrumentação durante as análises dinâmicas, como por exemplo, realizar o hooking de alguma função com o Frida. Acho que a parte mais legal, é de fato ofuscar até as chamadas criptográficas sem gerar (muitos) problemas no código, e também chegando ao âmbito de bibliotecas de código nativo, como alguns bancos nacionais o Facebook e diversos outros aplicativos delegam boa parte da suas funcionalidades de segurança e também do core business da aplicação.\nMas aqui vem um ponto muito importante, o ProGuard foca mais na miniturialização do código, adicionando funções muito simples e primitivas de ofuscação de código. Acredito que a única coisa que realmente seja ofuscada dentro da utilização do ProGuard, fique na troca das assinaturas dos nomes de classes, propriedades e funções. E que na maioria das vezes, o dicionário utilizado é bem determinístico, além da existência de diversas ferramentas de deobfuscation feitas especialmente para ele (um paper já antigo, mas que gostei muito quando li, escrito por um trio com artigos muito bem escritos, é o Anti-ProGuard: Towards Automated Deobfuscation of Android Apps, além do próprio Reconstruct, mas que claramente, é dependente do mapping dessas substituições) e também outros ofuscadores de código, acredito que os projetos mais mantidos são o Simplify e o dex-oracle, que foi a inspiração e base para várias outros deobfuscators.\nNo fim, nada vai substituir a sua capacidade de interpretar e entender código intermediário e pseudocódigo oriundo de algum decompilador. Um bom exercício é justamente estender as funcionalidade de decompiladores open-source ou que expõem alguma API de desenvolvimento, para olhar justamente para os padrões de códigos das funções que são interessantes para sua análise. Para não perder o costume, entenda bem da linguagem de programação utilizada, bem como o ambiente onde ela funcionará.\n  Nota: Esse artigo ainda é um draft, por tanto não pode remeter ao que de fato será escrito no final, se é que um dia vou terminar de escrever.\n ","wordCount":"1044","inLanguage":"en","datePublished":"2021-03-05T23:32:22-03:00","dateModified":"2021-03-05T23:32:22-03:00","author":{"@type":"Person","name":"Jojo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/"},"publisher":{"@type":"Organization","name":"Jojo's Exception","logo":{"@type":"ImageObject","url":"https://exception.blog/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://exception.blog accesskey=h title="Jojo's Exception (Alt + H)">Jojo's Exception</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://exception.blog/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Contornando a ofuscação de código no Android<div class=entry-isdraft><sup>&nbsp;&nbsp;[draft]</sup></div></h1><div class=post-description></div><div class=post-meta>March 5, 2021&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Jojo</div></header><div class=post-content><p>Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente <em>blackbox</em> (aqueles onde você tem o aplicativo, <code>.apk</code>, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no <em>bug hunting</em> e também como lazer.</p><blockquote><p><strong>Alerta</strong>: O texto é recheado de alguns RANTs, mas acredito que são necessários.</p></blockquote><p>Antes de aprofundar sobre o tema, gostaria de deixar um <em>disclaimer</em>: <strong>Se você trabalha, ou se intitula, como <em>pentester</em> ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na <em>stack</em> que está auditando</strong>, ou rabiscar <em>Hello, World!</em> de acordo com a sua senioridade. No geral, considero que, se caso você estiver em uma enrascada para analisar uma aplicação, e não souber desenvolver em nada naquela plataforma, ou se quer entende de fato o que acontece por de trás das cortinas, com certeza está <em>passando o carro na frente dos bois</em>.</p><p>Entender ao menos o básico do que está fazendo, é crucial para conseguir chegar do outro lado. Aposto com você, que o <em>Orange-Tsai</em> não indexou tantas vulnerabilidades críticas em aplicações baseadas na JVM (e também em PHP, e algumas outras dezenas de <em>stacks</em> de desenvolvimento) sem conhecer exatamente o que acontece até mesmo além da linguagem. Dito isso, talvez iniciar uma trilha de estudos focada nos conceitos básicos de desenvolvimento Android (para iOS, acredito que devo escrever algo focado especificamente para essa plataforma, e trazer um desenvolvedor nativo com mais experiência, não me sinto confortável para falar de Apple, visto que não atuo com seus produtos no dia-a-dia), e também de segurança ofensiva para ela.</p><blockquote><p>Na parte de <em>dev</em>, recomendo assinar a <a href=https://www.alura.com.br/>Alura</a>, e estudar um pouco de nativo, e também de aplicações híbridas. Claro que o ideal, é focar seus estudos na <em>stack</em> que mais atua. No meu caso, fico no Flutter, Xamarin e no NDK, que também já entraria em uma postagem exclusiva para ele (mas dando um <em>spoiler</em>, você não precisa do Android Studio para desenvolver para Android). Já na parte de segurança ofensiva, o melhor conteúdo em nosso idioma, é feito pelo grande <a href=https://maycon.hacknroll.io/br/about/>Maycon Vitali</a>, com a <a href=https://www.youtube.com/channel/UCcYYP7JizTd24W9Mr7FIhxw>Hack N' Roll Academy</a>.</p></blockquote><h1 id=a-sua-assinatura>A Sua Assinatura<a hidden class=anchor aria-hidden=true href=#a-sua-assinatura>#</a></h1><p>Começando com uma boa indicação de trilha sonora para o texto que vem a seguir, também vamos rever alguns entendimentos sobre o que é ofuscação de código, e o motivo da segurança por obscuridade - se é que a ofuscação de código pode ser considerada isso, eu sinceramente não sei responder, mas acredito que não. Mas acabo por ficar meio na dúvida, pois a vantagem, assim como na maioria das vezes, fica do lado do atacante -, ser tão amplamente implementada em aplicações Android. Em especial, aquelas de cunho financeiro, como <em>fintechs</em> e bancos no Brasil, na verdade já notei que diversas vezes os times de <em>Application Security</em> levam esse assunto e <em>certificate pinning</em> como bala de prata para aumentar a maturidade de segurança de uma aplicação, tentando deixar mais difícil a vida de quem vai audita-lá no futuro.</p><blockquote><p>A final de contas, para que utilizar a <a href=https://developer.android.com/training/safetynet/attestation>Safetynet</a>, se você pode reter informações críticas de negócio no <em>frontend</em> ou até mesmo deixar algum segredo por lá, temos a ofuscação de código à caminho! (Acredito que a <a href=https://www.guardsquare.com/pt-br>Guardsquare</a> deve abrir um sorriso no rosto com essa mentalidade).</p></blockquote><p>E sobre o tema anterior, voltamos a focar no item <strong>o que é ofuscação de código</strong>. Afinal de contas, para a maioria das consultorias de segurança, análise de segurança ofensiva em aplicações Android, se limita em realizar o <em>bypass</em> de alguma coisa, e focar nas interações com a internet (AKA olhar somente para RESTful ou algum outro SDK que faça chamadas para a internet) ao invés da aplicação.</p><p><em>Short long answer</em>, com as soluções já consagradas de mercado, como o <a href=https://www.guardsquare.com/en/blog/dexguard-vs-proguard>{Pro, Dex}Guard</a>, seus contextos de aplicação vão bem além de somente ofuscar um código. Até na variante <em>open-source</em>, o ProGuard, ele efetua a otimização do <em>bytecode</em>, remove trechos de códigos que não podem ser acessíveis devido a algum fluxo lógico na aplicação, e de fato, efetua a ofuscação baseado em um dicionário.</p><p>Na versão <em>enterprise</em>, o DexGuard, o negócio fica mais tenso. A proteção vai bem além de somente um <em>bytecode</em> direcionado para a JVM, e sai desse contexto que estamos comentando de análise estática, e vai até nas etapas de instrumentação durante as análises dinâmicas, como por exemplo, realizar o <em>hooking</em> de alguma função com o <a href=https://github.com/frida/frida>Frida</a>. Acho que a parte mais legal, é de fato ofuscar até as chamadas criptográficas sem gerar (muitos) problemas no código, e também chegando ao âmbito de bibliotecas de código nativo, como alguns bancos nacionais o Facebook e diversos outros aplicativos delegam boa parte da suas funcionalidades de segurança e também do <em>core business</em> da aplicação.</p><p>Mas aqui vem um ponto muito importante, o ProGuard foca mais na miniturialização do código, adicionando funções <strong>muito simples e primitivas</strong> de ofuscação de código. Acredito que a única coisa que realmente seja ofuscada dentro da utilização do ProGuard, fique na troca das assinaturas dos nomes de classes, propriedades e funções. E que na maioria das vezes, o dicionário utilizado é bem determinístico, além da existência de diversas ferramentas de <em>deobfuscation</em> feitas especialmente para ele (um <em>paper</em> já antigo, mas que gostei muito quando li, escrito por um trio com artigos muito bem escritos, é o <a href=https://www.researchgate.net/publication/320542477_Anti-ProGuard_Towards_Automated_Deobfuscation_of_Android_Apps>Anti-ProGuard: Towards Automated Deobfuscation of Android Apps</a>, além do próprio <a href=https://github.com/LXGaming/Reconstruct>Reconstruct</a>, mas que claramente, é dependente do <em>mapping</em> dessas substituições) e também outros ofuscadores de código, acredito que os projetos mais mantidos são o <a href=https://github.com/CalebFenton/simplify>Simplify</a> e o <a href=https://github.com/CalebFenton/dex-oracle>dex-oracle</a>, que foi a inspiração e base para várias outros <em>deobfuscators</em>.</p><p>No fim, nada vai substituir a sua capacidade de interpretar e entender código intermediário e pseudocódigo oriundo de algum decompilador. Um bom exercício é justamente estender as funcionalidade de decompiladores <em>open-source</em> ou que expõem alguma API de desenvolvimento, para olhar justamente para os padrões de códigos das funções que são interessantes para sua análise. Para não perder o costume, entenda bem da linguagem de programação utilizada, bem como o ambiente onde ela funcionará.</p><hr><blockquote><p><strong>Nota</strong>: Esse artigo ainda é um <em>draft</em>, por tanto não pode remeter ao que de fato será escrito no final, se é que um dia vou terminar de escrever.</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://exception.blog/tags/android-re/>android-re</a></li><li><a href=https://exception.blog/tags/research/>research</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://exception.blog>Jojo's Exception</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=https://exception.blog/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>
<!doctype html><html lang=en><head><title>Contornando a ofuscação de código no Android :: Terminal</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.
 Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.
 Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World!"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/><link rel=stylesheet href=https://exception.blog/assets/style.css><link rel=stylesheet href=https://exception.blog/assets/green.css><link rel=apple-touch-icon href=https://exception.blog/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://exception.blog/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Contornando a ofuscação de código no Android"><meta property="og:description" content="Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente blackbox (aqueles onde você tem o aplicativo, .apk, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no bug hunting e também como lazer.
 Alerta: O texto é recheado de alguns RANTs, mas acredito que são necessários.
 Antes de aprofundar sobre o tema, gostaria de deixar um disclaimer: Se você trabalha, ou se intitula, como pentester ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na stack que está auditando, ou rabiscar Hello, World!"><meta property="og:url" content="https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/"><meta property="og:site_name" content="Terminal"><meta property="og:image" content="https://exception.blog/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-03-05 23:32:22 -0300 -0300"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>exception</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>whois</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>whois</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://exception.blog/posts/contornando-ofusca%C3%A7%C3%A3o-de-c%C3%B3digo/>Contornando a ofuscação de código no Android</a></h1><div class=post-meta><span class=post-date>2021-03-05</span></div><span class=post-tags>#<a href=https://exception.blog/tags/android-re/>android-re</a>&nbsp;
#<a href=https://exception.blog/tags/research/>research</a>&nbsp;</span><div class=post-content><div><p>Das diversas coisas que já fiz em segurança de aplicações móveis, e dessas, principalmente testes totalmente <em>blackbox</em> (aqueles onde você tem o aplicativo, <code>.apk</code>, e deve procurar por vulnerabilidades nesse escopo incerto), acabou por ficar sendo uma das atividades que mais gosto de exercer no <em>bug hunting</em> e também como lazer.</p><blockquote><p><strong>Alerta</strong>: O texto é recheado de alguns RANTs, mas acredito que são necessários.</p></blockquote><p>Antes de aprofundar sobre o tema, gostaria de deixar um <em>disclaimer</em>: <strong>Se você trabalha, ou se intitula, como <em>pentester</em> ou correlatos, focados em segurança em aplicações móveis, no mínimo você deve saber programar muito bem na <em>stack</em> que está auditando</strong>, ou rabiscar <em>Hello, World!</em> de acordo com a sua senioridade. No geral, considero que, se caso você estiver em uma enrascada para analisar uma aplicação, e não souber desenvolver em nada naquela plataforma, ou se quer entende de fato o que acontece por de trás das cortinas, com certeza está <em>passando o carro na frente dos bois</em>.</p><p>Entender ao menos o básico do que está fazendo, é crucial para conseguir chegar do outro lado. Aposto com você, que o <em>Orange-Tsai</em> não indexou tantas vulnerabilidades críticas em aplicações baseadas na JVM (e também em PHP, e algumas outras dezenas de <em>stacks</em> de desenvolvimento) sem conhecer exatamente o que acontece até mesmo além da linguagem. Dito isso, talvez iniciar uma trilha de estudos focada nos conceitos básicos de desenvolvimento Android (para iOS, acredito que devo escrever algo focado especificamente para essa plataforma, e trazer um desenvolvedor nativo com mais experiência, não me sinto confortável para falar de Apple, visto que não atuo com seus produtos no dia-a-dia), e também de segurança ofensiva para ela.</p><blockquote><p>Na parte de <em>dev</em>, recomendo assinar a <a href=https://www.alura.com.br/>Alura</a>, e estudar um pouco de nativo, e também de aplicações híbridas. Claro que o ideal, é focar seus estudos na <em>stack</em> que mais atua. No meu caso, fico no Flutter, Xamarin e no NDK, que também já entraria em uma postagem exclusiva para ele (mas dando um <em>spoiler</em>, você não precisa do Android Studio para desenvolver para Android). Já na parte de segurança ofensiva, o melhor conteúdo em nosso idioma, é feito pelo grande <a href=https://maycon.hacknroll.io/br/about/>Maycon Vitali</a>, com a <a href=https://www.youtube.com/channel/UCcYYP7JizTd24W9Mr7FIhxw>Hack N' Roll Academy</a>.</p></blockquote><h1 id=a-sua-assinatura>A Sua Assinatura<a href=#a-sua-assinatura class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Começando com uma boa indicação de trilha sonora para o texto que vem a seguir, também vamos rever alguns entendimentos sobre o que é ofuscação de código, e o motivo da segurança por obscuridade - se é que a ofuscação de código pode ser considerada isso, eu sinceramente não sei responder, mas acredito que não. Mas acabo por ficar meio na dúvida, pois a vantagem, assim como na maioria das vezes, fica do lado do atacante -, ser tão amplamente implementada em aplicações Android. Em especial, aquelas de cunho financeiro, como <em>fintechs</em> e bancos no Brasil, na verdade já notei que diversas vezes os times de <em>Application Security</em> levam esse assunto e <em>certificate pinning</em> como bala de prata para aumentar a maturidade de segurança de uma aplicação, tentando deixar mais difícil a vida de quem vai audita-lá no futuro.</p><blockquote><p>A final de contas, para que utilizar a <a href=https://developer.android.com/training/safetynet/attestation>Safetynet</a>, se você pode reter informações críticas de negócio no <em>frontend</em> ou até mesmo deixar algum segredo por lá, temos a ofuscação de código à caminho! (Acredito que a <a href=https://www.guardsquare.com/pt-br>Guardsquare</a> deve abrir um sorriso no rosto com essa mentalidade).</p></blockquote><p>E sobre o tema anterior, voltamos a focar no item <strong>o que é ofuscação de código</strong>. Afinal de contas, para a maioria das consultorias de segurança, análise de segurança ofensiva em aplicações Android, se limita em realizar o <em>bypass</em> de alguma coisa, e focar nas interações com a internet (AKA olhar somente para RESTful ou algum outro SDK que faça chamadas para a internet) ao invés da aplicação.</p><p><em>Short long answer</em>, com as soluções já consagradas de mercado, como o <a href=https://www.guardsquare.com/en/blog/dexguard-vs-proguard>{Pro, Dex}Guard</a>, seus contextos de aplicação vão bem além de somente ofuscar um código. Até na variante <em>open-source</em>, o ProGuard, ele efetua a otimização do <em>bytecode</em>, remove trechos de códigos que não podem ser acessíveis devido a algum fluxo lógico na aplicação, e de fato, efetua a ofuscação baseado em um dicionário.</p><p>Na versão <em>enterprise</em>, o DexGuard, o negócio fica mais tenso. A proteção vai bem além de somente um <em>bytecode</em> direcionado para a JVM, e sai desse contexto que estamos comentando de análise estática, e vai até nas etapas de instrumentação durante as análises dinâmicas, como por exemplo, realizar o <em>hooking</em> de alguma função com o <a href=https://github.com/frida/frida>Frida</a>. Acho que a parte mais legal, é de fato ofuscar até as chamadas criptográficas sem gerar (muitos) problemas no código, e também chegando ao âmbito de bibliotecas de código nativo, como alguns bancos nacionais o Facebook e diversos outros aplicativos delegam boa parte da suas funcionalidades de segurança e também do <em>core business</em> da aplicação.</p><p>Mas aqui vem um ponto muito importante, o ProGuard foca mais na miniturialização do código, adicionando funções <strong>muito simples e primitivas</strong> de ofuscação de código. Acredito que a única coisa que realmente seja ofuscada dentro da utilização do ProGuard, fique na troca das assinaturas dos nomes de classes, propriedades e funções. E que na maioria das vezes, o dicionário utilizado é bem determinístico, além da existência de diversas ferramentas de <em>deobfuscation</em> feitas especialmente para ele (um <em>paper</em> já antigo, mas que gostei muito quando li, escrito por um trio com artigos muito bem escritos, é o <a href=https://www.researchgate.net/publication/320542477_Anti-ProGuard_Towards_Automated_Deobfuscation_of_Android_Apps>Anti-ProGuard: Towards Automated Deobfuscation of Android Apps</a>, além do próprio <a href=https://github.com/LXGaming/Reconstruct>Reconstruct</a>, mas que claramente, é dependente do <em>mapping</em> dessas substituições) e também outros ofuscadores de código, acredito que os projetos mais mantidos são o <a href=https://github.com/CalebFenton/simplify>Simplify</a> e o <a href=https://github.com/CalebFenton/dex-oracle>dex-oracle</a>, que foi a inspiração e base para várias outros <em>deobfuscators</em>.</p><p>No fim, nada vai substituir a sua capacidade de interpretar e entender código intermediário e pseudocódigo oriundo de algum decompilador. Um bom exercício é justamente estender as funcionalidade de decompiladores <em>open-source</em> ou que expõem alguma API de desenvolvimento, para olhar justamente para os padrões de códigos das funções que são interessantes para sua análise. Para não perder o costume, entenda bem da linguagem de programação utilizada, bem como o ambiente onde ela funcionará.</p><hr><blockquote><p><strong>Nota</strong>: Esse artigo ainda é um <em>draft</em>, por tanto não pode remeter ao que de fato será escrito no final, se é que um dia vou terminar de escrever.</p></blockquote></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://exception.blog/posts/hackeando-apps-financeiros-para-osint/><span class=button__text>Hackeando apps financeiros para OSINT (e pela zueira): Tudo pelo PIX!</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://exception.blog/assets/main.js></script><script src=https://exception.blog/assets/prism.js></script></div></body></html>
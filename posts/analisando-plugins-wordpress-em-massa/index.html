<!doctype html><html lang=en><head><title>Analisando plguins wordpress em massa :: Jojo's Exceptions</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Acredito que a grande maioria do pessoal que procura vulnerabilidades rentáveis dentro do mundo de aplicações web, em algum momento já passou pela stack que o WordPress fornece, seja auditando seu core, ou plugins, sendo este último o foco dessa postagem.
Junto a um simples crawler escrito em C# 9.0 (só não usei os recursos do 10 pois não havia necessidade de delegates), vamos percorrer todos os plugins listáveis na index do site do projeto, e organiza-lo em uma estrutura contendo o próprio ."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://exception.blog/posts/analisando-plugins-wordpress-em-massa/><link rel=stylesheet href=https://exception.blog/assets/style.css><link rel=stylesheet href=https://exception.blog/assets/red.css><link rel=apple-touch-icon href=https://exception.blog/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://exception.blog/favicon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Analisando plguins wordpress em massa"><meta property="og:description" content="Acredito que a grande maioria do pessoal que procura vulnerabilidades rentáveis dentro do mundo de aplicações web, em algum momento já passou pela stack que o WordPress fornece, seja auditando seu core, ou plugins, sendo este último o foco dessa postagem.
Junto a um simples crawler escrito em C# 9.0 (só não usei os recursos do 10 pois não havia necessidade de delegates), vamos percorrer todos os plugins listáveis na index do site do projeto, e organiza-lo em uma estrutura contendo o próprio ."><meta property="og:url" content="https://exception.blog/posts/analisando-plugins-wordpress-em-massa/"><meta property="og:site_name" content="Jojo's Exceptions"><meta property="og:image" content="https://exception.blog/favicon.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-07-06 23:38:32 -0300 -0300"></head><body class=red><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>exception</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>whois</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>whois</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://exception.blog/posts/analisando-plugins-wordpress-em-massa/>Analisando plguins wordpress em massa</a></h1><div class=post-meta><span class=post-date>2021-07-06</span>
<span class=post-author>:: jojo</span></div><span class=post-tags>#<a href=https://exception.blog/tags/scraping/>scraping</a>&nbsp;
#<a href=https://exception.blog/tags/research/>research</a>&nbsp;
#<a href=https://exception.blog/tags/csharp/>csharp</a>&nbsp;</span><div class=post-content><div><p>Acredito que a grande maioria do pessoal que procura vulnerabilidades rentáveis dentro do mundo de aplicações web, em algum momento já passou pela <em>stack</em> que o WordPress fornece, seja auditando seu <code>core</code>, ou plugins, sendo este último o foco dessa postagem.</p><p>Junto a um simples <em>crawler</em> escrito em C# 9.0 (só não usei os recursos do 10 pois não havia necessidade de <code>delegates</code>), vamos percorrer todos os <em>plugins</em> listáveis na <em>index</em> do site do projeto, e organiza-lo em uma estrutura contendo o próprio <code>.zip</code> com o código do plugin.</p><blockquote><p><strong>Nota</strong>: Caso tenha interesse em apenas utilizar o <em>crawler</em>, verifique-o no código em <em>highlight</em> logo abaixo.</p></blockquote><h1 id=top-level-program>Top-level program<a href=#top-level-program class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Por não haver a necessidade de termos uma estrutura de programa complexa, vamos utilizar os recursos que o C# 9.0 tem de melhor, em trazer minimalismo na hora de construir uma aplicação de linha de comando: Com <em>top-level programs</em>. Dentro dessa linguagem, essa caracteristica permite que escrevamos código sem o <em>template</em> clássico do <code>static void Main()</code>.</p><p><img src=/static/26f475e9f2a847fe0bbf2eab.png alt="Apresentação do site"></p><p>Para análisar o HTML da página, e não passar raiva ou perder tempo com expressões regulares ou ficar refém de algo como <code>LastIndexOf()</code> ou <code>IndexOf()</code>, irei utilizar o <code>AngleParse</code> como biblioteca para realizar o <em>parsing</em> da sopa de letras que vamos extrair do site exibido acima. Um ponto de atenção na hora de fazer o <em>crawling</em>, é justamente se antentar onde será realizado, tendo em vista que a listagem completa dos quase 60 mil plugins não é possível.</p><blockquote><p><strong>Nota</strong>: Também vamos fazer tudo isso assíncrono e paralelo, utilizando <code>async</code> e <code>SemaphoreSlim</code>.</p></blockquote><p>Ah, e seguindo a linha das outras postagens, o código vou escrevendo conforme vou conseguindo tempo no meu dia-a-dia, por tanto essa postagem também se remete a essa condição, e pode ser atualizada constantemente conforme meu humor varie. Caso tenha visto alguma coisa que alterou, todo o blog está disponível em meu GitHub no <code>/exception</code>.</p><p>Sem mais esperneios, vamos ao código-fonte. Esse que talvez não seja muito <em>begginers friendly</em>, tendo em vista a utilização de recursos bem avançados do C#, porém, ainda contendo esse tipo de código, sua legibilidade é realmente simples:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.IO;
<span style=color:#66d9ef>using</span> System.Net;
<span style=color:#66d9ef>using</span> System.Linq;
<span style=color:#66d9ef>using</span> System.Net.Http;
<span style=color:#66d9ef>using</span> System.Threading;
<span style=color:#66d9ef>using</span> System.Threading.Tasks;
<span style=color:#66d9ef>using</span> System.Collections.Generic;
<span style=color:#66d9ef>using</span> System.Collections.Concurrent;

<span style=color:#66d9ef>using</span> AngleSharp.Html.Dom;
<span style=color:#66d9ef>using</span> AngleSharp.Html.Parser;

<span style=color:#66d9ef>using</span> static System.Console;


<span style=color:#66d9ef>var</span> clientHandler = <span style=color:#66d9ef>new</span> HttpClientHandler
{
    AllowAutoRedirect = <span style=color:#66d9ef>false</span>,
    UseCookies = <span style=color:#66d9ef>true</span>,
    CookieContainer = <span style=color:#66d9ef>new</span> CookieContainer()
};
<span style=color:#66d9ef>var</span> client = <span style=color:#66d9ef>new</span> HttpClient(clientHandler);
<span style=color:#66d9ef>var</span> parser = <span style=color:#66d9ef>new</span> HtmlParser();
<span style=color:#66d9ef>var</span> semaphore = <span style=color:#66d9ef>new</span> SemaphoreSlim(Environment.ProcessorCount);
<span style=color:#66d9ef>var</span> downloadList = <span style=color:#66d9ef>new</span>[]
{
    <span style=color:#e6db74>&#34;https://wordpress.org/plugins/browse/popular/&#34;</span>,
    <span style=color:#e6db74>&#34;https://wordpress.org/plugins/browse/beta/&#34;</span>,
    <span style=color:#e6db74>&#34;https://wordpress.org/plugins/browse/featured/&#34;</span>,
    <span style=color:#e6db74>&#34;https://wordpress.org/plugins/browse/blocks/&#34;</span>
};

WriteLine(<span style=color:#e6db74>&#34;[+] Crawler started with a possible total of {0} thread(s)&#34;</span>, Environment.ProcessorCount);

<span style=color:#66d9ef>var</span> pluginsPages = <span style=color:#66d9ef>new</span> ConcurrentBag&lt;<span style=color:#66d9ef>string</span>&gt;();
<span style=color:#66d9ef>async</span> Task GetAllPluginsPagesAsync(<span style=color:#66d9ef>string</span> target)
{
    <span style=color:#66d9ef>await</span> semaphore.WaitAsync();

    <span style=color:#66d9ef>var</span> response = <span style=color:#66d9ef>await</span> client.GetAsync(target);
    <span style=color:#66d9ef>if</span> (!response.IsSuccessStatusCode) <span style=color:#66d9ef>return</span>;

    <span style=color:#66d9ef>var</span> counter = <span style=color:#ae81ff>2</span>;
    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>)
    {
        <span style=color:#66d9ef>var</span> content = <span style=color:#66d9ef>await</span> response.Content.ReadAsStringAsync();
        <span style=color:#66d9ef>var</span> soup = <span style=color:#66d9ef>await</span> parser.ParseDocumentAsync(content);
        <span style=color:#66d9ef>var</span> navs = soup.All
            .Where(e =&gt; e.LocalName == <span style=color:#e6db74>&#34;div&#34;</span> &amp;&amp; e.GetAttribute(<span style=color:#e6db74>&#34;class&#34;</span>) == <span style=color:#e6db74>&#34;nav-links&#34;</span>)
            .ToList();

        <span style=color:#66d9ef>if</span> (navs.Count == <span style=color:#ae81ff>0</span>)
        {
            pluginsPages.Add(content);
            <span style=color:#66d9ef>break</span>;
        }
        
        pluginsPages.Add(content);
        response = <span style=color:#66d9ef>await</span> client.GetAsync(target + <span style=color:#e6db74>$&#34;page/{counter}/&#34;</span>);
        <span style=color:#66d9ef>if</span> (!response.IsSuccessStatusCode) <span style=color:#66d9ef>break</span>;

        counter += <span style=color:#ae81ff>1</span>;
    }

    semaphore.Release();
}

<span style=color:#66d9ef>var</span> downloadTasks = <span style=color:#66d9ef>new</span> List&lt;Task&gt;();
downloadList.ToList().ForEach(d =&gt; downloadTasks.Add(GetAllPluginsPagesAsync(d)));
<span style=color:#66d9ef>await</span> Task.WhenAll(downloadTasks);

WriteLine(<span style=color:#e6db74>&#34;[+] Downloaded {0} page(s) with unique plugins from WordPress&#34;</span>, pluginsPages.Count);

<span style=color:#66d9ef>var</span> pluginPages = <span style=color:#66d9ef>new</span> ConcurrentBag&lt;<span style=color:#66d9ef>string</span>&gt;();
<span style=color:#66d9ef>async</span> Task GetPluginPageAsync(<span style=color:#66d9ef>string</span> page)
{
    <span style=color:#66d9ef>await</span> semaphore.WaitAsync();

    <span style=color:#66d9ef>var</span> soup = <span style=color:#66d9ef>await</span> parser.ParseDocumentAsync(page);
    <span style=color:#66d9ef>var</span> headers = soup.All
        .Where(e =&gt; e.LocalName == <span style=color:#e6db74>&#34;h3&#34;</span> &amp;&amp; e.GetAttribute(<span style=color:#e6db74>&#34;class&#34;</span>) == <span style=color:#e6db74>&#34;entry-title&#34;</span>)
        .Select(e =&gt; e.InnerHtml)
        .ToList();
    
    <span style=color:#66d9ef>if</span> (headers.Count &lt;= <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span>;
    headers.ForEach(<span style=color:#66d9ef>async</span> c =&gt;
    {
        <span style=color:#66d9ef>var</span> anchor = <span style=color:#66d9ef>await</span> parser.ParseDocumentAsync(c);
        <span style=color:#66d9ef>if</span> (anchor.All.FirstOrDefault(e =&gt; e.LocalName == <span style=color:#e6db74>&#34;a&#34;</span>) <span style=color:#66d9ef>is</span> not IHtmlAnchorElement href) <span style=color:#66d9ef>return</span>;
        pluginPages.Add(href.Href);
    });

    semaphore.Release();
}

<span style=color:#66d9ef>var</span> parserTasks = <span style=color:#66d9ef>new</span> List&lt;Task&gt;();
pluginsPages.ToList().ForEach(p =&gt; parserTasks.Add(GetPluginPageAsync(p)));
<span style=color:#66d9ef>await</span> Task.WhenAny(parserTasks);

<span style=color:#66d9ef>var</span> pluginsPagesUniq = pluginPages.Distinct().ToList();
WriteLine(<span style=color:#e6db74>&#34;[+] Downloaded {0} plugin page(s)&#34;</span>, pluginsPagesUniq.Count);

<span style=color:#66d9ef>if</span> (!Directory.Exists(<span style=color:#e6db74>&#34;output&#34;</span>)) Directory.CreateDirectory(<span style=color:#e6db74>&#34;output&#34;</span>);

<span style=color:#66d9ef>async</span> Task DownloadPluginAsync(<span style=color:#66d9ef>string</span> href)
{
    <span style=color:#66d9ef>await</span> semaphore.WaitAsync();

    <span style=color:#66d9ef>var</span> response = <span style=color:#66d9ef>await</span> client.GetAsync(href);
    <span style=color:#66d9ef>var</span> content = <span style=color:#66d9ef>await</span> response.Content.ReadAsStringAsync();
    <span style=color:#66d9ef>var</span> soup = <span style=color:#66d9ef>await</span> parser.ParseDocumentAsync(content);

   
    <span style=color:#66d9ef>if</span> (soup.All.FirstOrDefault(e =&gt; e.LocalName == <span style=color:#e6db74>&#34;a&#34;</span> &amp;&amp; 
                                     e.GetAttribute(<span style=color:#e6db74>&#34;class&#34;</span>) == 
                                     <span style=color:#e6db74>&#34;plugin-download button download-button button-large&#34;</span>) 
        <span style=color:#66d9ef>is</span> not IHtmlAnchorElement downloadLink) <span style=color:#66d9ef>return</span>;

    response = <span style=color:#66d9ef>await</span> client.GetAsync(downloadLink.Href);
    <span style=color:#66d9ef>var</span> streamContent = <span style=color:#66d9ef>await</span> response.Content.ReadAsStreamAsync();

    <span style=color:#66d9ef>var</span> pluginFileName = downloadLink.Href.Split(<span style=color:#e6db74>&#34;/&#34;</span>).Last();
    WriteLine(<span style=color:#e6db74>&#34;[+] Downloading file {0}...&#34;</span>, pluginFileName);
    
    <span style=color:#66d9ef>var</span> path = Path.Combine(<span style=color:#e6db74>&#34;output&#34;</span>, pluginFileName);
    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>using</span> var stream = <span style=color:#66d9ef>new</span> FileStream(path, FileMode.CreateNew);
    streamContent.Seek(<span style=color:#ae81ff>0</span>, SeekOrigin.Begin);
    streamContent.CopyTo(stream);
    
    semaphore.Release();
}

<span style=color:#66d9ef>var</span> downloadPluginTasks = <span style=color:#66d9ef>new</span> List&lt;Task&gt;();
pluginsPagesUniq.ForEach(l =&gt; downloadPluginTasks.Add(DownloadPluginAsync(l)));
<span style=color:#66d9ef>await</span> Task.WhenAll(downloadPluginTasks);

</code></pre></div><p>Basicamente, na primeira etapa do código, inicializamos uma lista contendo as URLs de todos os alvos que vamos utilizar para popular a segunda lista concorrente, que é representada pela própria pagína do plugin.</p><p>Na sequência, pegamos essa mesma listagem de páginas, e extraimos somente as URLs para download dos plugins. Por fim, temos individualmente todas as páginas dos plugins para download, e então, realizam-se o tal ato.</p><p>Caso você for realizar o <em>debugging</em>, em especial na altura da lógica correspondente a lista <code>pluginsPagesUniq</code>, você pode se perguntar a necessidade de realizar um <code>Distinct()</code> do conteúdo da lista concorrente, bom, isso acontece pois um plugin pode estar listado em mais de uma página, dai não seria legal ter entidades repetidas no nosso conjunto.</p><blockquote><p><strong>Nota</strong>: Existem formas muito mais fáceis e inteligentes de se fazer isso, porém, pegar todos os plugins mais famosos dessa forma, é muito mais <em>style</em> e divertido.</p></blockquote><h1 id=rodando-o-código>Rodando o código<a href=#rodando-o-código class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Ao executar o código acima (instalando a única depêndencia, que é o <code>AngleSharp</code>) você terá em menos de dois minutos (caso tiver um processador com no minímo 8 <em>threads</em>) mais de 1400 plugins baixados no diretório <code>output</code> à partir do diretório que foi utilizado para compilar e executar o código. Algo nessa vibe:</p><pre><code>[+] Crawler started with a possible total of 20 thread(s)
[+] Downloaded 76 page(s) with unique plugins from WordPress
[+] Downloaded 1395 plugin page(s)
[+] Downloading file wp-lazy-loading.zip...
[+] Downloading file background-image-cropper.zip...
[+] Downloading file akismet.4.1.10.zip...
[+] Downloading file classic-editor.1.6.1.zip...
[+] Downloading file rollback-update-failure.0.5.3.zip...
[+] Downloading file health-check.1.4.5.zip...
[+] Downloading file wp-jquery-update-test.2.0.0.zip...
...
</code></pre><p>A sazonalidade da quantidade de plugins disponíveis para download pode variar bastante dependendo de como os usuários do WordPress utilizam os pluginss, mas a aplicação tende a funcionar até que aconteça alguma grande mudança nas telas do próprio site do WordPress.</p><h1 id=e-sobre-análise>E sobre análise?<a href=#e-sobre-análise class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Caso você só esteja buscando uma CVE para chamar de sua, é bem mais fácil buscar nos plugins com poucos downloads ou mais obscuros na comunidade. Agora, se acredita ter o suficiente para contornar a análise que já é realizada pelo WordPress, tanto automaticamente, quanto manualmente, dependendo da popularidade do plugin, sem contar a análise que a própria cena de segurança da informação faz, esse aqui é o caminho.</p><blockquote><p>Todavia, o <code>semgrep</code> cantará de qualquer forma.</p></blockquote></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://exception.blog/posts/interagir-em-enquetes-no-linkedin-e-uma-pessima-ideia/><span class=button__text>Interagir em enquetes abertas no LinkedIn é uma péssima ideia!</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://exception.blog/assets/main.js></script><script src=https://exception.blog/assets/prism.js></script></div></body></html>